<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mr.Stack Dashboard</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
  --bg: var(--tg-theme-bg-color, #1a1a2e);
  --text: var(--tg-theme-text-color, #e0e0e0);
  --hint: var(--tg-theme-hint-color, #888);
  --link: var(--tg-theme-link-color, #64b5f6);
  --btn: var(--tg-theme-button-color, #7c4dff);
  --btn-text: var(--tg-theme-button-text-color, #fff);
  --secondary-bg: var(--tg-theme-secondary-bg-color, #16213e);
  --section: var(--tg-theme-section-bg-color, var(--secondary-bg));
  --card-radius: 12px;
  --gap: 12px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, 'SF Pro', 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  padding: var(--gap);
  min-height: 100vh;
}

.header {
  text-align: center;
  padding: 16px 0 12px;
}
.header h1 { font-size: 20px; font-weight: 600; }
.header .subtitle { color: var(--hint); font-size: 13px; margin-top: 4px; }

.stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--gap);
  margin-bottom: var(--gap);
}

.stat-card {
  background: var(--section);
  border-radius: var(--card-radius);
  padding: 14px;
  text-align: center;
}
.stat-card .value {
  font-size: 24px;
  font-weight: 700;
  color: var(--link);
}
.stat-card .label {
  font-size: 11px;
  color: var(--hint);
  margin-top: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.section {
  background: var(--section);
  border-radius: var(--card-radius);
  padding: 14px;
  margin-bottom: var(--gap);
}
.section-title {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.job-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}
.job-item:last-child { border-bottom: none; }
.job-info { flex: 1; }
.job-name { font-size: 13px; font-weight: 500; }
.job-cron { font-size: 11px; color: var(--hint); }
.job-actions { display: flex; gap: 6px; }

.btn {
  background: var(--btn);
  color: var(--btn-text);
  border: none;
  border-radius: 8px;
  padding: 6px 12px;
  font-size: 12px;
  cursor: pointer;
  font-weight: 500;
  transition: opacity 0.2s;
}
.btn:active { opacity: 0.7; }
.btn.outline {
  background: transparent;
  border: 1px solid var(--btn);
  color: var(--btn);
}
.btn.danger { background: #e53935; }

.toggle {
  width: 44px;
  height: 24px;
  border-radius: 12px;
  background: #555;
  position: relative;
  cursor: pointer;
  transition: background 0.3s;
}
.toggle.active { background: #4caf50; }
.toggle::after {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #fff;
  top: 2px;
  left: 2px;
  transition: transform 0.3s;
}
.toggle.active::after { transform: translateX(20px); }

.memory-file {
  font-size: 12px;
  padding: 4px 0;
  color: var(--hint);
  display: flex;
  justify-content: space-between;
}

.activity-item {
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}
.activity-item:last-child { border-bottom: none; }
.activity-prompt {
  font-size: 13px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.activity-meta {
  font-size: 11px;
  color: var(--hint);
  margin-top: 2px;
}

.loading {
  text-align: center;
  padding: 20px;
  color: var(--hint);
}

.refresh-bar {
  text-align: center;
  padding: 8px;
  font-size: 11px;
  color: var(--hint);
}
</style>
</head>
<body>

<div class="header">
  <h1>Mr.Stack</h1>
  <div class="subtitle">Dashboard</div>
</div>

<div class="stats-grid">
  <div class="stat-card">
    <div class="value" id="stat-today">-</div>
    <div class="label">Today</div>
  </div>
  <div class="stat-card">
    <div class="value" id="stat-sessions">-</div>
    <div class="label">Sessions</div>
  </div>
  <div class="stat-card">
    <div class="value" id="stat-jobs">-</div>
    <div class="label">Jobs</div>
  </div>
</div>

<div class="section">
  <div class="section-title">Schedule</div>
  <div id="jobs-list"><div class="loading">Loading...</div></div>
</div>

<div class="section">
  <div class="section-title">Memory</div>
  <div id="memory-info"><div class="loading">Loading...</div></div>
</div>

<div class="section">
  <div class="section-title">Recent Activity</div>
  <div id="activity-list"><div class="loading">Loading...</div></div>
</div>

<div class="refresh-bar" id="refresh-bar">Auto-refresh: 30s</div>

<script>
const tg = window.Telegram?.WebApp;
if (tg) {
  tg.ready();
  tg.expand();
}

const BASE = window.location.origin + '/dashboard';

async function fetchJSON(path) {
  try {
    const res = await fetch(BASE + path);
    return await res.json();
  } catch (e) {
    console.error('Fetch error:', path, e);
    return null;
  }
}

async function loadStats() {
  const data = await fetchJSON('/api/stats');
  if (!data || data.error) return;
  document.getElementById('stat-today').textContent = data.today_interactions;
  document.getElementById('stat-sessions').textContent = data.total_sessions;
  document.getElementById('stat-jobs').textContent = data.active_jobs;
}

async function loadJobs() {
  const jobs = await fetchJSON('/api/jobs');
  const container = document.getElementById('jobs-list');
  if (!jobs || jobs.length === 0) {
    container.innerHTML = '<div class="loading">No jobs</div>';
    return;
  }
  container.innerHTML = jobs.map(j => `
    <div class="job-item">
      <div class="job-info">
        <div class="job-name">${j.name}</div>
        <div class="job-cron">${j.cron}</div>
      </div>
      <div class="job-actions">
        <div class="toggle ${j.active ? 'active' : ''}"
             onclick="toggleJob('${j.name}', this)"></div>
        <button class="btn outline" onclick="runJob('${j.name}')">Run</button>
      </div>
    </div>
  `).join('');
}

async function loadMemory() {
  const data = await fetchJSON('/api/memory');
  const container = document.getElementById('memory-info');
  if (!data || data.status !== 'active') {
    container.innerHTML = '<div class="loading">Not configured</div>';
    return;
  }
  let html = `<div class="memory-file"><span>${data.file_count} files</span><span>${data.interaction_count} interactions</span></div>`;
  data.files.slice(0, 8).forEach(f => {
    const size = f.size > 1024 ? (f.size/1024).toFixed(1) + 'KB' : f.size + 'B';
    html += `<div class="memory-file"><span>${f.path}</span><span>${size}</span></div>`;
  });
  container.innerHTML = html;
}

async function loadActivity() {
  const items = await fetchJSON('/api/activity');
  const container = document.getElementById('activity-list');
  if (!items || items.length === 0) {
    container.innerHTML = '<div class="loading">No activity</div>';
    return;
  }
  container.innerHTML = items.map(a => `
    <div class="activity-item">
      <div class="activity-prompt">${escapeHtml(a.prompt)}</div>
      <div class="activity-meta">${a.session_id} &middot; ${formatTime(a.timestamp)}</div>
    </div>
  `).join('');
}

async function toggleJob(name, el) {
  const res = await fetch(BASE + `/api/jobs/${name}/toggle`, {method: 'POST'});
  const data = await res.json();
  if (data.active !== undefined) {
    el.classList.toggle('active', data.active);
  }
  loadStats();
}

async function runJob(name) {
  await fetch(BASE + `/api/jobs/${name}/run`, {method: 'POST'});
  if (tg) tg.showAlert(`${name} triggered`);
}

function escapeHtml(text) {
  const d = document.createElement('div');
  d.textContent = text;
  return d.innerHTML;
}

function formatTime(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  return d.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
}

async function refresh() {
  await Promise.all([loadStats(), loadJobs(), loadMemory(), loadActivity()]);
  document.getElementById('refresh-bar').textContent =
    `Updated: ${new Date().toLocaleTimeString('ko-KR')}`;
}

refresh();
setInterval(refresh, 30000);
</script>
</body>
</html>
